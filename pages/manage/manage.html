<link rel="stylesheet" href="../static/styles/manage/manage.css">
<div class="main" id="app">
    <div class="breadcrumb">
        <a href="">首页</a>
        <span class="line">/</span>
        <span>pipeline管理</span>
    </div>
    <!-- 搜索框 -->
    <div class="search-wrapper clearfix">
        <div class="input-group">
            <span class="input-group-label">客户：</span>
            <div class="autoComplete-wrapper" id="autoCompleteWrapper"></div>
        </div>
        <div class="dropdown-wrap">
            <span class="dropdown-label">行业线：</span>
            <div class="dropdown">
                <span class="dropdown-default">{{ cIndustryLineText }}</span>
                <i class="fa fa-angle-down"></i>
                <ul>
                    <li @click="searchIndustryLineCode(searchList.code, searchList.text)"
                        v-for="searchList in searchLists.industryLines">{{ searchList.text }}</li>
                </ul>
            </div>
        </div>
        <div class="input-group">
            <span class="input-group-label">预计签约时间：</span>
            <input class="input-group-form"
                   id="startDate"
                   @click=""
                   v-model="tableList.expectSignDateStart">
        </div>
        <div class="dropdown-wrap">
            <span class="dropdown-label">成功率：</span>
            <div class="dropdown">
                <span class="dropdown-default">{{ cProjectSuccessRateText }}</span>
                <i class="fa fa-angle-down"></i>
                <ul>
                    <li @click="searchSuccessRateCode(searchList.code, searchList.text)"
                        v-for="searchList in searchLists.projectSuccessRates"
                        :value="searchList.code">{{ searchList.text }}</li>
                </ul>
            </div>
        </div>
        <div class="dropdown-wrap">
            <span class="dropdown-label">事业部：</span>
            <div class="dropdown">
                <span class="dropdown-default">{{ cMngSalesGroupText }}</span>
                <i class="fa fa-angle-down"></i>
                <ul>
                    <!--TODO 如果当前人是领导的话，就用userInfo.mngSalesGroups下面的code和text；否则就用userInfo.departmentCode和userInfo.departmentName-->
                    <li @click="searchSalesGroupCode(oauthList.code, oauthList.text)"
                        v-for="oauthList in mngSalesGroups"
                        :value="oauthList.code">{{ oauthList.text }}</li>
                </ul>
            </div>
        </div>
        <div class="dropdown-wrap">
            <span class="dropdown-label">区域：</span>
            <div class="dropdown">
                <span class="dropdown-default">{{ cRegionText }}</span>
                <i class="fa fa-angle-down"></i>
                <ul>
                    <li @click="searchRegionCode(searchList.code, searchList.text)"
                        v-for="searchList in searchLists.regions"
                        :value="searchList.code">{{ searchList.text }}</li>
                </ul>
            </div>
        </div>
        <div class="dropdown-wrap">
            <span class="dropdown-label">客户来源：</span>
            <div class="dropdown">
                <span class="dropdown-default">{{ cCustomerSourText }}</span>
                <i class="fa fa-angle-down"></i>
                <ul>
                    <li @click="searchCustomerSourceCode(searchList.code, searchList.text)"
                        v-for="searchList in searchLists.customerSours"
                        :value="searchList.code">{{ searchList.text }}</li>
                </ul>
            </div>
        </div>
        <div class="dropdown-wrap">
            <span class="dropdown-label">解决方案：</span>
            <div class="dropdown-zTree">
                <span class="dropdown-default">{{ cSoSolutionText }}</span>
                <i class="fa fa-angle-down"></i>
                <ul class="selectTree ztree soSolutionTree"
                    style="max-height: 200px;overflow-y: auto;"></ul>
            </div>
        </div>
        <div class="dropdown-wrap">
            <span class="dropdown-label">近期变更过：</span>
            <div class="dropdown">
                <span class="dropdown-default">{{ cLatelyChangeText }}</span>
                <i class="fa fa-angle-down"></i>
                <ul>
                    <li @click="searchLatelyChangeCode(searchList.code, searchList.text)"
                        v-for="searchList in searchLists.latelyChanges">{{ searchList.text }}</li>
                </ul>
            </div>
        </div>
        <div class="input-group pull-right">
            <span class="input-group-label"></span>
            <button @click="resettingHandle"
                    class="btn btn-sm btn-theme"
                    type="button">重置</button>
        </div>
    </div>
    <div class="main-wrapper">
        <div :class="{maxWidth: ismaxWidth}" class="data">
            <div class="subInformation">
                <button @click="addData"
                        class="btn btn-sm btn-theme modelDomBtn"
                        style="margin-right: 10px">新增 Pipeline</button>
                <div @click="upload" class="btn btn-theme" style="margin-right: 15px">
                    <i class="fa fa-cloud-upload"></i>
                    <span>导入</span>
                </div>
                加权金额总计（万元）：<span class="theme-color">{{  weightedSumTotal }}</span>
                <div class="pull-right">
                    <div class="client-page page-css">
                        <div @click="calcPage('client' , 'first')"
                             class="page-css-first">
                            <i class="fa fa-angle-double-left"></i></div>
                        <div @click="calcPage('client' , -1)"
                             class="page-css-prev"
                             style="margin-right: 10px;">
                            <i class="fa fa-angle-left"></i></div>
                        <span>第</span><input @keyup.enter="showData" type="text" style="margin: 0 5px;" v-model="clientPageNum"><span>页，</span>
                        <span>共 {{clientPageSum}} 页，</span>
                        <div @click="calcPage('client' , 1)"
                             class="page-css-next"><i class="fa fa-angle-right  "></i></div>
                        <div @click="calcPage('client' , 'last')" class="page-css-last" style="margin-right: 10px;"><i
                                class="fa fa-angle-double-right"></i></div>
                        <span>显示</span>
                        <span style="margin-left: 5px;">{{clientPageStart}}</span>
                        <span>-</span>
                        <span style="margin-right: 5px;">{{clientPageEnd}}</span>
                        <span>条，</span>
                        <span>共&nbsp; {{clientPageTotal}} &nbsp;条</span>
                    </div>
                </div>
            </div>
            <div class="table-wrapper" style="overflow: auto">
                <div style="width: 3500px">
                    <table class="i-table i-table-border">
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th>操作</th>
                                <th>报备日期</th>
                                <th>销售事业部</th>
                                <th>销售</th>
                                <th>售前</th>
                                <th>区域</th>
                                <th>客服所在省份</th>
                                <th>客户属性</th>
                                <th>客户编号</th>
                                <th>客户名称</th>
                                <th>解决方案名称</th>
                                <th>行业线</th>
                                <th>项目性质</th>
                                <th>合作伙伴名称</th>
                                <th>预计签约金额（万元）</th>
                                <th>预计签约时间</th>
                                <th>项目阶段</th>
                                <th>成功率</th>
                                <th>加权金额 （万元）</th>
                                <th>项目跟进情况</th>
                                <th>确切需要其他部门配合的地方</th>
                                <th>竞争对手</th>
                                <th>客户来源</th>
                                <th>备注-项目名称</th>
                                <th>金融银行分类</th>
                            </tr>
                            </thead>
                            <!--<tbody :class="{'hide': noData}">-->
                            <!--<tr>-->
                                <!--<td colspan="25" style="height: 48px;">{{ emptyMsg }}</td>-->
                            <!--</tr>-->
                            <!--</tbody>-->
                            <tbody>
                                <tr v-for="(item, index) in items"
                                    @click="showOneChange(item,index)"
                                    :class="{'active': (vm.clientPageNum -1) * 10 + (index + 1) == 1} ">
                                    <td>{{ (vm.clientPageNum -1) * 10 + (index + 1) }}</td>
                                    <td><a @click="handleData(item)" data-toggle="modal" data-target=".myModal" class="modelDomBtn" href="javascript:;"><i class="fa fa-edit"></i></a></td>
                                    <td>{{ item.reportDate }}</td>
                                    <td>{{ item.salesGroupName }}</td>
                                    <td>{{ item.salesStaffName }}</td>
                                    <td><div v-for="preSaleStaffs in item.preSaleStaffs">
                                        {{ preSaleStaffs.userName }}
                                    </div></td>
                                    <td>{{ item.region }}</td>
                                    <td>{{ item.province }}</td>
                                    <td>{{ item.customerProperties }}</td>
                                    <td>{{ item.salesStaffName }}</td>
                                    <td>{{ item.customerName }}</td>
                                    <td><div v-for="solutionSub in item.solutionSub">
                                        {{ solutionSub.solutionName }}
                                    </div></td>
                                    <td>{{ item.industryLine }}</td>
                                    <td>{{ item.projectNature }}</td>
                                    <td>{{ item.cooperativePartner }}</td>
                                    <td>{{ addSum(item.solutionSub) }}</td>
                                    <td>{{ item.expectSignDate }}</td>
                                    <td>{{ item.progress }}</td>
                                    <td>{{ item.successRate }}</td>
                                    <td>{{ item.weightedSum }}</td>
                                    <td>{{ item.projectFollowUpRemark }}</td>
                                    <td>{{ item.othDescription }}</td>
                                    <td>{{ item.competitor }}</td>
                                    <td>{{ item.customerSource }}</td>
                                    <td>{{ item.projectDescription }}</td>
                                    <td>{{ item.classificationOfFinancialIndustry }}</td>
                                </tr>
                            </tbody>
                        </table>
                </div>
            </div>
        </div>
            <div class="updateCase" :class="{'hide': updateCaseShow}">
            <div class="title clearfix">
                <span>项目更新情况</span>
                <a @click="closeUpdateCase" class="close pull-right" href="javascript:;">
                    <i class="fa fa-close"></i>
                </a>
            </div>
            <div class="content">
                <ul class="block">
                    <li v-for="changeOneList in changeOneLists">
                        <h4>{{ changeOneList.opTime }}</h4>
                        <p>{{ changeOneList.operName }}{{ changeOneList.opDetail }}</p>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- 新增修改pipeline弹窗 -->
    <div class="dialog-wrap"
         :class="{'hide': dialogShow}">
        <div @click="allHide" class="dialog-cover"></div>
        <div class="dialog-content" style="width: auto">
            <div class="title clearfix">
                <p v-if="handleTemplate.soCoreCode != null" class="pull-left">修改 Pipeline</p>
                <p v-if="handleTemplate.soCoreCode == null" class="pull-left">新增 Pipeline</p>
                <p @click="allHide" class="dialog-close pull-right" ><i class="fa fa-close"></i></p>
            </div>
            <div class="main">
                <div id="aboutPipeline" class="data-wrapper">
                    <div class="wrapper">
                        <div class="main">
                            <form class="clearfix" id="dataSubmit" action="">
                                <input type="hidden" v-model="handleTemplate.soCoreCode" name="soCoreCode">
                                <div class="block-wrapper">
                                    <div class="input-group">
                                        <span class="input-group-label">报备日期:</span>
                                        <span style="line-height: 30px;">{{ cReportDate }}</span>
                                    </div>
                                </div>
                                <div class="block-wrapper">
                                    <div class="dropdown-wrap">
                                        <i class="star">*</i>
                                        <span class="dropdown-label">事业部：</span>
                                        <div class="dropdown">
                                            <span id="salesGroupCode" ref="salesGroupCode" class="selected dropdown-default">请选择</span>
                                            <i class="fa fa-angle-down"></i>
                                            <ul>
                                                <li @click="selectSalesGroupCode(oauthList.code)"
                                                    v-for="oauthList in mngSalesGroups"
                                                    :value="oauthList.code">{{ oauthList.text }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="block-wrapper">
                                    <div class="input-group">
                                        <i class="star">*</i>
                                        <span class="input-group-label">负责销售:</span>
                                        <span style="line-height: 30px;">{{ cSalesStaffCode }}</span>
                                    </div>
                                </div>
                                <div class="block-wrapper">
                                    <!--TODO  如何获取对象下的数组-->
                                    <div class="input-group">
                                        <span class="input-group-label">负责售前:</span>
                                        <input v-model="preSaleStaffs.userCode" class="input-group-form" type="text">
                                    </div>
                                </div>
                                <div class="block-wrapper col-1">
                                    <div class="input-group">
                                        <i class="star">*</i>
                                        <span class="input-group-label">区域:</span>
                                        <ul id="tierFirst" class="item-list radioCheck clearfix">
                                            <!--:class="{'active': index == 0}"-->
                                            <li v-for="(searchList,index) in searchLists.regions"
                                                :value="searchList.code"
                                                ref="regionCode"
                                                :class="handleTemplate.regionCode == searchList.code ? 'active':''">{{ searchList.text }}</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="block-wrapper col-1">
                                    <div class="input-group">
                                        <i class="star">*</i>
                                        <span class="input-group-label">客户所在省份:</span>
                                        <ul id="tierSecond" class="item-list radioCheck clearfix">
                                            <!--:class="{'active': index == isActiveProvince}"-->
                                            <li @click="activeProvince(provinceList.code, index)"
                                                v-for="(provinceList,index) in provinceLists"
                                                :value="provinceList.code"
                                                :class="handleTemplate.provinceCode == provinceList.code ? 'active':''"
                                                ref="provinceCode">{{ provinceList.text }}</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="block-wrapper col-1">
                                    <div class="input-group">
                                        <i class="star">*</i>
                                        <span class="input-group-label">客户属性:</span>
                                        <ul class="item-list radioCheck clearfix">
                                            <li v-for="(customerName,index) in customerAttr"
                                                :class="handleTemplate.customerPropertiesCode == customerName.code ? 'active':''"
                                                :value="customerName.code"
                                                ref="customerPropertiesCode">{{ customerName.text }}</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="block-wrapper col-1">
                                    <div class="input-group">
                                        <i class="star">*</i>
                                        <span class="input-group-label">客户名称:</span>
                                        <input @click=""
                                               v-model="handleTemplate.customerName"
                                               class="input-group-form noNull" type="text">
                                        <!-- @click="selectCustomer"-->
                                        <a href="javascript:;"
                                           style="margin-left: 10px;font-weight: bold;font-size: 18px">+</a>
                                    </div>
                                </div>
                                <div class="block-wrapper col-1">
                                    <div class="dropdown-wrap">
                                        <span class="dropdown-label">解决方案：</span>
                                        <div class="dropdown-zTree">
                                            <span id="addTreeName" class="dropdown-default">请选择</span>
                                            <i class="fa fa-angle-down"></i>
                                            <ul class="handleTree ztree soSolutionTree" style="max-height: 200px;overflow-y: auto;"></ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="block-wrapper">
                                    <div class="dropdown-wrap">
                                        <i class="star">*</i>
                                        <span class="dropdown-label">行业线：</span>
                                        <div class="dropdown noNull">
                                            <span id="industryLineCode" ref="industryLineCode" class="selected dropdown-default">请选择</span>
                                            <i class="fa fa-angle-down"></i>
                                            <ul>
                                                <li @click="selectIndustryLineCode(searchList.code)"
                                                    v-for="searchList in searchLists.industryLines"
                                                    :value="searchList.code">{{ searchList.text }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="block-wrapper col-1">
                                        <div class="input-group">
                                            <i class="star">*</i>
                                            <span class="input-group-label">项目性质:</span>
                                            <ul class="item-list radioCheck clearfix">
                                                <li v-for="(searchList,index) in searchLists.projectNatures"
                                                    :value="searchList.code"
                                                    :class="handleTemplate.projectNatureCode == searchList.code ? 'active':''"
                                                    ref="projectNatureCode">{{ searchList.text }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="block-wrapper col-1">
                                        <div class="input-group">
                                            <span class="input-group-label">合作伙伴:</span>
                                            <input v-model="handleTemplate.cooperativePartner" class="input-group-form" type="text">
                                        </div>
                                    </div>
                                    <div class="block-wrapper">
                                        <!--TODO  如何获取对象下的数组-->
                                        <div class="input-group">
                                            <i class="star">*</i>
                                            <span class="input-group-label" style="width: auto">预计签约金额（万元）:</span>
                                            <input v-model="solutionSub.expectSignSum"
                                                   class="input-group-form noNull"
                                                   type="text"
                                                   style="text-align: right;padding-right: 10px">
                                        </div>
                                    </div>
                                    <div class="block-wrapper">
                                        <div class="input-group">
                                            <span class="input-group-label">预计签约时间：</span>
                                            <div class="i-date-picker-container">
                                                <div class="date-input-box  icon iconfont icon-cale-a">
                                                    <input v-model="handleTemplate.expectSignDate"
                                                           type="text"
                                                           id="signDate"
                                                           class="i-date-picker"
                                                           data-calendar="true" >
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="block-wrapper">
                                        <div class="dropdown-wrap">
                                            <i class="star">*</i>
                                            <span class="dropdown-label">成功率：</span>
                                            <div class="dropdown noNull">
                                                <span id="successRateCode" ref="successRateCode" class="selected dropdown-default">请选择</span>
                                                <i class="fa fa-angle-down"></i>
                                                <ul>
                                                    <li @click="selectSuccessRateCode(searchList.code)" v-for="searchList in searchLists.projectSuccessRates" :value="searchList.code">{{ searchList.text }}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="block-wrapper">
                                        <div class="dropdown-wrap">
                                            <i class="star">*</i>
                                            <span class="dropdown-label">项目阶段：</span>
                                            <div class="dropdown noNull">
                                                <span id="progressCode" ref="progressCode" class="selected dropdown-default">请选择</span>
                                                <i class="fa fa-angle-down"></i>
                                                <ul>
                                                    <li @click="selectProgressCode(searchList.code)" v-for="searchList in searchLists.progresss" :value="searchList.code">{{ searchList.text }}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="block-wrapper">
                                        <div class="dropdown-wrap">
                                            <span class="dropdown-label">客户来源：</span>
                                            <div class="dropdown">
                                                <span id="customerSourceCode" ref="customerSourceCode" class="selected dropdown-default">请选择</span>
                                                <i class="fa fa-angle-down"></i>
                                                <ul>
                                                    <li @click="selectCustomerSourceCode(searchList.code)" v-for="searchList in searchLists.customerSours" :value="searchList.code">{{ searchList.text }}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="block-wsrapper">
                                        <div class="input-group">
                                            <span class="input-group-label">金融银行分类:</span>
                                            <input v-model="handleTemplate.classificationOfFinancialIndustry" class="input-group-form" type="text">
                                        </div>
                                    </div>
                                    <div class="block-wrapper col-1">
                                        <div class="input-group" style="display: block;">
                                            <span class="input-group-label">项目跟进情况:</span>
                                            <div>
                                           <textarea v-model="handleTemplate.projectFollowUpRemark" class="input-group-form" style="display: block"
                                                     placeholder="请详细的描述您申请该项资源的使用场景，内容包括但不限于该资源用于什么类型的应用，以及对该资源的具体需求如执行单元数量、内存大小等。"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="block-wrapper col-1">
                                        <div class="input-group" style="display: block;">
                                            <span class="input-group-label" style="width: auto">需要其他部门配合的地方:</span>
                                            <div>
                                            <textarea v-model="handleTemplate.othDescription" class="input-group-form" style="display: block"
                                                      placeholder="请详细的描述您申请该项资源的使用场景，内容包括但不限于该资源用于什么类型的应用，以及对该资源的具体需求如执行单元数量、内存大小等。"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="block-wrapper col-1">
                                        <div class="input-group">
                                            <span class="input-group-label">竞争对手:</span>
                                            <input v-model="handleTemplate.competitor" class="input-group-form" type="text">
                                        </div>
                                    </div>
                                    <div class="block-wrapper col-1">
                                        <div class="input-group">
                                            <span class="input-group-label">备注-项目名称:</span>
                                            <input v-model="handleTemplate.projectDescription" class="input-group-form" type="text">
                                        </div>
                                    </div>
                                    <div class="block-wrapper">
                                        <div class="input-group">
                                            <span class="input-group-label"></span>
                                            <button @click="submitHandle" class="btn btn-sm btn-theme" type="button">提交</button>
                                        </div>
                                    </div>
                            </form>
                        </div>
                        <div class="explain">
                            <div class="title clearfix">
                                <span>项目更新情况</span>
                                <a onclick="loadMainPage('.content-item', 'client/client.html')"
                                   class="theme-color pull-right" href="javascript:;">清空配置</a>
                            </div>
                            <div class="content">
                                <div>区域：<span>华北-北京</span></div>
                                <div>成功率：<span> 100%，90% </span></div>
                                <p class="tips">温馨提示:功率从10%50%。客户所在省份从广东省调整为云南省。 预计签约金额从2018年1月调整到2019年2月。</p>
                            </div>
                        </div>
                    </div>
                    <div v-if="handleTemplate.soCoreCode != null" class="historyLog">
                        <input id="checkLog" class="hide" type="checkbox">
                        <label for="checkLog" class="head">历史变更信息<i class="fa fa-chevron-down"></i></label>
                        <div class="content">
                            <div>
                                <span class="theme-color" style="margin-right: 15px"> 变更记录</span>
                                最近一次变更时间在：<span class="theme-color">2018-03-05 09:20</span>
                                <div class="pull-right" style="display: none">这里是分页</div>
                            </div>
                            <table class="i-table i-table-border">
                                <thead>
                                <tr>
                                    <th>操作人</th>
                                    <th>操作时间</th>
                                    <th>操作明细</th>
                                    <th>操作类型</th>
                                    <th>自定义字段1</th>
                                    <th>自定义字段2</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="changeList in changeLists">
                                    <td>{{ changeList.operName }}</td>
                                    <td>{{ changeList.opTime }}</td>
                                    <td>{{ changeList.opDetail }}</td>
                                    <td>{{ changeList.opType }}</td>
                                    <td>{{ changeList.ext1 }}</td>
                                    <td>{{ changeList.ext2 }}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- /.main -->
        </div>
    </div>
    <!-- 客户信息弹窗 -->
    <div class="dialog-wrap"
         :class="{'hide': customerDialogShow}">
        <div @click="customerDialogHide" class="dialog-cover"></div>
        <div class="dialog-content" style="width: 1090px">
            <div class="title clearfix">
                <p class="pull-left">客户选择</p>
                <p @click="customerDialogHide" class="dialog-close pull-right" ><i class="fa fa-close"></i></p>
            </div>
            <div class="main">
                <div class="opera clearfix">
                    <div class="industry">
                        <div class="dropdown-wrap">
                            <span class="dropdown-label">行业:</span>
                            <div class="dropdown">
                                <span v-text="hDropText" class="dropdown-default"></span>
                                <i class="fa fa-angle-down"></i>
                                <ul>
                                    <li v-for="searchList in searchLists.industryLines"
                                        v-text="searchList.text"
                                        @click="hDrop(searchList.code, searchList.text)"></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="client-num">
                        <div class="input-group">
                            <span class="input-group-label">客户编号:</span>
                            <input v-model="hClientCode" type="text" class="input-group-form">
                        </div>
                    </div>

                    <div class="client-name">
                        <div class="input-group">
                            <span class="input-group-label">客户名称:</span>
                            <input v-model="hClientName" type="text" class="input-group-form">
                        </div>
                    </div>

                    <div class="query-reset pull-right">
                        <div @click="queryBtn" class="btn btn-theme" style="margin-right: 20px;">查询</div>
                        <div @click="resetBtn" class="btn btn-border pull-right">重置</div>
                    </div>
                </div><!-- /.opera -->
                <div class="client">
                    <div class="table-opera clearfix">
                        <div class="pull-right">
                            <div class="client-page page-css">
                                <div @click="calcPage('client' , 'first')"
                                     class="page-css-first"><i class="fa fa-angle-double-left"></i></div>
                                <div @click="calcPage('client' , -1)" class="page-css-prev" style="margin-right: 10px;"><i
                                        class="fa fa-angle-left"></i></div>
                                <span>第</span><input @keyup.enter="clientEnter" type="text" style="margin: 0 5px;" v-model="clientPageNum"><span>页，</span>
                                <span>共 {{clientPageSum}} 页，</span>
                                <div @click="calcPage('client' , 1)"
                                     class="page-css-next"><i class="fa fa-angle-right  "></i></div>
                                <div @click="calcPage('client' , 'last')" class="page-css-last" style="margin-right: 10px;"><i
                                        class="fa fa-angle-double-right"></i></div>
                                <span>显示</span>
                                <span style="margin-left: 5px;">{{clientPageStart}}</span>
                                <span>-</span>
                                <span style="margin-right: 5px;">{{clientPageEnd}}</span>
                                <span>条，</span>
                                <span>共&nbsp; {{clientPageTotal}} &nbsp;条</span>
                            </div>
                        </div>
                    </div>
                    <table class="i-table">
                        <thead style="background-color: #FAD3B2;color: #433C38;">
                        <tr>
                            <th>序号</th>
                            <th>报备名称</th>
                            <th>所属事业部</th>
                            <th>客户编号</th>
                            <th>客户名称</th>
                            <th>行业线</th>
                            <th>地址</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="(item ,index) in client.root"
                            :class="{'tr-active': index == cCheckIndex}"
                            @click="selectCustomerName(item.customerName, index)">
                            <td v-text="index +1"></td>
                            <td v-text="item.reportDate"></td>
                            <td v-text="item.salesGroup"></td>
                            <td v-text="item.customerCode"></td>
                            <td v-text="item.customerName"></td>
                            <td v-text="item.industryLine"></td>
                            <td v-text="item.address"></td>
                        </tr>
                        </tbody>
                    </table>
                    <div style="text-align: right">
                        <button @click="selectHandle" class="btn btn-sm btn-theme" type="button">选中</button>
                    </div>

                </div><!-- /.client -->
            </div><!-- /.main -->
        </div>
    </div>
    <!-- 导入 -->
    <div class="dialog-wrap"
         :class="{'hide': uploadDialogShow}">
        <div @click="allHide" class="dialog-cover"></div>
        <div class="dialog-content upload-pop" style="width: 400px;min-width: 400px;overflow: hidden;">
            <div class="title clearfix">
                <p class="pull-left">导入文件</p>
                <p @click="allHide" class="dialog-close pull-right" ><i class="fa fa-close"></i></p>
            </div>
            <div class="main">
                <div class="select-file">
                    <label for="importFile">选择文件</label>
                    <input id="importFile" type="file">
                </div>
                <div class="btn-group">
                    <div @click="uploadConfirm" class="btn btn-theme">确认</div>
                    <div @click="allHide" class="btn btn-border">取消</div>
                </div>
            </div><!-- /.main -->
        </div>
    </div>
</div>
<script src="../static/scripts/manage/manage.js"></script>
<script>
    $.ajaxSettings.async = true;
    $(document).ready(function() {
        // 搜索-预计签约时间
        laydate.render({
            elem: '#startDate' //指定元素
            ,type: 'month'
            ,range: true
            // 参数可选value, date(起始时间), endDate(结束时间)
            ,done: function(value) {
                vm.cExpectSignDateRange = value;
                var time = vm.cExpectSignDateRange.split(' - ');
                var startTime,
                    endTime;
                startTime = time[0];
                endTime = time[1];
                vm.tableList.expectSignDateStart = startTime;
                vm.tableList.expectSignDateEnd = endTime;

                vm.showData();
            }
        });
        // 预计签约时间
        laydate.render({
            elem: '#signDate' //指定元素
            ,type: 'month'
        });
    })
    //zTree
    var setting = {
        data: {
            key: {
                title: "t"
            },
            simpleData: {
                enable: true
            }
        },
        callback: {
            beforeClick: beforeClick,
            onClick: onClick
        }
    };
    // 解决方案书树形结构内容
    var zNodes = [];
    var treeName = '';
    function beforeClick(treeId, treeNode, clickFlag) {
        return (treeNode.click != false);
    }
    function onClick(event, treeId, treeNode, clickFlag) {
        vm.solutionSub.solutionCode = '';
        if($(event.currentTarget).hasClass('selectTree')){
            vm.cSoSolutionText = treeNode.name
            //搜索的时候传解决方案名称code
            vm.tableList.soSolutionCode = treeNode.code;
            vm.showData();
        }else{
            $('#addTreeName').text(treeNode.name);
            //新增/修改的时候传解决方案code
            vm.solutionSub.solutionCode = treeNode.id;
        }
        // console.log("[onClick ]&nbsp;&nbsp;clickFlag = " + clickFlag + " (" + (clickFlag===1 ? "普通选中": (clickFlag===0 ? "<b>取消选中</b>" : "<b>追加选中</b>")) + ")");
        event.stopPropagation();
    }
</script>
<script>
    var vm = new Vue({
        el: '#app',
        data: function(){
            return {
                // 定义搜索值信息
                cIndustryLineText: '',        // 行业线
                cProjectSuccessRateText: '',  // 成功率
                cMngSalesGroupText: '',       // 事业部
                cRegionText: '',              // 区域
                cCustomerSourText: '',        // 客户来源
                cSoSolutionText: '',          // 解决方案
                cLatelyChangeText: '',        // 近期变更过
                cExpectSignDateRange: '',     // 预计签约时间
                // cExpectSignDateStart: '',  // 预计签约起始时间
                // cExpectSignDateEnd: '',    // 预计签约结束时间

                // 关闭表格右侧项目更新情况
                updateCaseShow: false,
                ismaxWidth: false,

                customerAttr: [],             // 客户属性
                customerLists: [],            // 客户信息
                regions: '',                  // 区域code
                isHide: false,               // 若区域下无省份，则隐藏省份块
                provinceLists: [],            // 客户所在省份
                searchLists: [{               // 初始值基本信息
                    latelyChanges: '',        // 近期变更过
                    industryLines: ''         // 行业线
                }],
                oauthLists: [],               // 初始值权限信息
                mngSalesGroups: [],
                weightedSumTotal: '',         // 加权金额
                items: [],                    // 表格数据
                noData: false,               // 搜索不到数据
                emptyMsg: '',
                // 分页
                client: [],
                clientPageTotal: 0,          // 全部数据
                clientPageNum: 1,            // 当前页
                clientPageSum: 1,            // 共多少页
                clientPageMost: 10,          // 页容量
                clientPageStart: 0,
                clientPageEnd: 0,

                opDataKey: '',               // 查询Pipeline变动历史  操作DATA主键
                changeOneLists: [],          //
                tableList: {},               //存放搜索值
                // 添加模板
                handleTemplate: {},
                changeLists: [],             // 变动历史
                isnoNull: 0,
                isActive: 0,
                isModal: false,
                mngSalesGroupsList: [],
                showModal: false,
                salesStaffCode: '',
                salesGroupCode: '',
                isClicked: false,           // 是否点击table的tr
                isActiveProvince: -1,
                // 添加
                cReportDate: timeYear,      // 报备时间
                cSalesStaffCode: userName,  // 负责销售
                cSalesGroupCode: '',        // 事业部
                csuccessRateCode: '',       // 成功率


                preSaleStaffs: [],          // 点击修改时获取表格的值
                solutionSub: [],            // 点击修改时获取表格的值

                // 新增修改弹窗
                dialogShow: true,
                addMsgShow: true,

                // 导入
                uploadDialogShow: true,     // 导入弹窗
                uploadFileName: '',
                clearShow: true,

                // 客户选择
                // 客户
                clientID: '',
                client: [],
                cCheckIndex: 0,

                customerDialogShow: true,  // 显示客户选择弹窗
                hDropText: '',// 行业下拉框文字
                hDropCode: '',// 行业 code
                hClientCode: '',// 客户编号
                hClientName: '',// 客户名称
            }
        },
        mounted: function(){
            this.customerData();
            this.searchCustomer();
            this.searchData();
            this.showData();
            this.showChange();
        },
        methods: {
            //// ==========搜索获取下拉code========
            // 选中行业线
            searchIndustryLineCode: function(code, text) {
                this.tableList.industryLineCode = code;
                vm.cIndustryLineText = text;
                this.showData();
            },
            // 选中成功率
            searchSuccessRateCode: function(code, text) {
                this.tableList.projectSuccessRateCode = code;
                vm.cProjectSuccessRateText = text;
                this.showData();
            },
            // 选中事业部
            searchSalesGroupCode: function(code, text) {
                this.tableList.salesGroupCode = code;
                vm.cMngSalesGroupText = text;
                this.showData();
            },
            // 选中区域
            searchRegionCode: function(code, text) {
                this.tableList.regionCode = code;
                vm.cRegionText = text;
                this.showData();
            },
            // 选中客户来源
            searchCustomerSourceCode: function(code, text) {
                this.tableList.customerSourceCode = code;
                vm.cCustomerSourText = text;
                this.showData();
            },
            // 选中近期变更过
            searchLatelyChangeCode: function(code, text) {
                this.tableList.latelyChangeCode = code;
                vm.cLatelyChangeText = text;
                this.showData();
            },

            //// ==========添加获取code========
            // 选中事业部
            selectSalesGroupCode: function(code) {
                this.handleTemplate.salesGroupCode = code;
            },
            // 选中行业线
            selectIndustryLineCode: function(code) {
                this.handleTemplate.industryLineCode = code;
            },
            // 选中成功率
            selectSuccessRateCode: function(code) {
                this.handleTemplate.successRateCode = code;
            },
            // 选中项目阶段
            selectProgressCode: function(code) {
                this.handleTemplate.progressCode = code;
            },
            // 选中客户来源
            selectCustomerSourceCode: function(code) {
                this.handleTemplate.customerSourceCode = code;
            },
            addClient: function () {
                vm.dialogShow = false;
            },
            addMsg: function () {
                vm.dialogShow = false;
                vm.addMsgShow = false;
            },
            allHide: function () {
                vm.dialogShow = true;
                vm.addMsgShow = true;
                vm.uploadDialogShow = true;
            },
            activeProvince: function(code,index){
                this.isActiveProvince = index;

                this.handleTemplate.provinceCode = code;
            },
            // 获取客户属性
            customerData: function(){
                $.ajax({
                    url:  PATH + '/basic/queryDictDataByCategory',
                    type: 'get',
                    dataType: 'json',
                    data: {
                         categoryCodes: 'customerAttr'
                    },
                    success: function(result){
                        // console.log(result.msg.customerAttr)
                        vm.customerAttr = result.msg.customerAttr;
                    },
                    error: function(result) {
                        console.log(' 请求失败');
                    }
                })
            },
            // 搜索客户信息
            searchCustomer: function(){
                $.ajax({
                    url:  PATH + '/crm/queryCustomerList',
                    type: 'get',
                    dataType: 'json',
                    data: {
                        'name': name
                    },
                    success: function(result){
                        // console.log(result);
                        var root = result.root,
                            array = new Array(),codeArr = new Array();
                        for(var i = 0;i < root.length;i++){
                            array.push(root[i].customerName);
                            codeArr.push(root[i].customerCode);
                        }
                        $('#autoCompleteWrapper').autocomplete({
                            hints: array,
                            codeval:codeArr,
                            showButton: false,
                            width: 200,
                            height: 30,
                            onSubmit: function(code){
                                vm.tableList.customerCode = code
                                vm.showData()
                            }
                        });
                    },
                    error: function(result) {
                        console.log('搜索客户信息请求失败');
                    }
                })
            },
            // 单人查看变动历史
            showOneChange: function(item,index) {
                // 点击tr的时候，给它添加'active'
                $("tr:eq("+ (index + 1) +")").addClass('active').siblings().removeClass('active');
                this.updateCaseShow = false
                this.ismaxWidth = false

                this.isClicked = 1; // 显示右侧项目更新情况
                vm.changeOneLists = []
                // console.log(item.soCoreCode)
                $.ajax({
                    url:  PATH + '/so/queryPipelineChangeHis',
                    type: 'get',
                    dataType: 'json',
                    data: {
                        'opDataKey': item.soCoreCode
                    },
                    success: function(result){
                        for(var i = 0;i < result.root.length;i++){
                            var root = result.root[i];
                            vm.changeOneLists.push(root);
                        }
                    },
                    error: function(){
                        console.log('查看单人变动历史 请求失败');
                    }
                })
            },
            // 关闭表格右侧内容
            closeUpdateCase: function() {
                this.updateCaseShow = true
                this.ismaxWidth = true
            },
            // 表格查询 加权金额相加
            addSum: function(sumList){
                var sum = 0;
                for(var i = 0;i < sumList.length;i++){
                    sum += parseFloat(sumList[i].expectSignSum)
                }
                // console.log(sum);
                return sum;
            },
            // 表格查询
            showData: function(){
                this.tableList.page = parseInt(this.clientPageNum);
                this.tableList.limit = 10;
                console.log(this.tableList)
                this.items = []
                $.ajax({
                    url:  PATH + '/so/queryPipeline',
                    type: 'get',
                    dataType: 'json',
                    data: this.tableList,
                    success: function(result){
                        console.log(result);
                        vm.weightedSumTotal = result.oth.weightedSumTotal;

                        // 点击tr，
                        for(var i = 0;i < result.root.length;i++){
                            var root = result.root[i];
                            if(i == 0){
                                vm.showOneChange(root);
                            }
                            vm.items.push(root);
                        }
                        // 如果表格无数据，那么关闭右侧项目更新情况
                        if(result.root.length === 0) {
                            // this.noData = true;
                            // this.emptyMsg = '没有数据';
                            vm.closeUpdateCase();
                            toastr.warning('没有相关信息 ！');
                            return;
                        }

                        vm.client = result;
                        vm.clientPageTotal = result.totalProperty;
                        vm.clientPageSum = Math.ceil(vm.clientPageTotal / vm.clientPageMost)
                        vm.clientPageStart = (vm.clientPageNum -1) * vm.clientPageMost + 1;

                        if (vm.clientPageNum === vm.clientPageSum) {
                            vm.clientPageEnd = vm.clientPageTotal;
                            return;
                        }
                        vm.clientPageEnd = vm.clientPageStart - 1 + vm.clientPageMost;
                    },
                    error: function(result) {
                        console.log('表格查询请求失败');
                    }
                })
            },
            // 分页
            calcPage: function (type, num) {
                type === 'client' ? vm.clientPage(type, num) : vm.msgPage(type, num);
            },// calcPage
            // 分页输入回车事件
            clientEnter: function () {
                vm.showData();
            },
            clientPage: function (type, num) {
                switch(num)
                {
                    case 'first':
                        vm.clientPageNum = 1;
                        vm.showData();
                        break;
                    case 'last':
                        vm.clientPageNum = vm.clientPageSum;
                        vm.clientPageEnd = vm.clientPageTotal;
                        vm.showData();
                        // console.log(vm.clientPageTotal)
                        // console.log(vm.clientPageEnd)
                        break;
                    case 1:
                        if(vm.clientPageNum >= vm.clientPageSum)  return;
                        vm.clientPageNum++;
                        vm.showData();
                        break;
                    case -1:
                        if(vm.clientPageNum <= 1)  return;
                        vm.clientPageNum--;
                        vm.showData();
                        break;

                }
            },
            // 搜索框赋值
            searchData: function(){
                console.log(this.tableList.expectSignDateStart)
                var basic,
                    oauth;
                $.ajax({
                    url:  PATH + '/so/queryPipelineInitVal',
                    type: 'get',
                    dataType: 'json',
                    success: function(result){
                        basic = result.msg.basic;
                        oauth = result.msg.oauth;
                        if(result !== null){
                            if(basic !== null){
                                vm.searchLists = basic;
                            }
                            if(oauth !== null){
                                vm.oauthLists = oauth;
                                vm.mngSalesGroups = vm.oauthLists.userInfo.mngSalesGroups;
                            }
                        }
                        // 获取解决方案树
                        var treeList = basic.soSolution4Tree;
                        if(treeList != null) {
                            for(var i = 0;i < treeList.length;i++) {
                                var pObj = {
                                    id: treeList[i].id,
                                    pId: treeList[i].parentId,
                                    name: treeList[i].text,
                                    t: treeList[i].text,
                                    open:true, click:false
                                }
                                zNodes.push(pObj);
                                if(treeList[i].children != null) {
                                    for(var j = 0;j < treeList[i].children.length;j++) {
                                        var cObj = {
                                            id:treeList[i].children[j].id,
                                            pId: treeList[i].children[j].parentId,
                                            name: treeList[i].children[j].text,
                                            t: treeList[i].children[j].text,
                                            code: treeList[i].children[j].data.code
                                        };
                                        zNodes.push(cObj);
                                    }
                                }
                            }
                        }
                        // console.log(zNodes);
                        $.fn.zTree.init($(".soSolutionTree"), setting, zNodes);

                        // 获取客户所在省份
                        for(var i = 0;i < basic.regions.length;i++) {
                            vm.regions += basic.regions[i].code + ',';
                            // console.log(basic.regions[i])
                        }
                        // console.log(regions)  // 取得所有区域code
                        $.ajax({
                            url:  PATH + '/basic/queryDictDataByCategory',
                            type: 'get',
                            dataType: 'json',
                            data: {
                                'categoryCodes': vm.regions
                            },
                            success: function(result){
                                vm.provinceLists = eval('result.msg.' + $('#tierFirst li').eq(0).attr('value'))

                                $('#tierFirst li').click(function(){
                                    var code = $(this).attr('value');
                                    // console.log(code)  // 获取到每个点击li的code值
                                    // console.log(eval('result.msg.' + code))
                                    vm.provinceLists = [];
                                    vm.provinceLists = eval('result.msg.' + code)
                                })

                            },
                            error:function(){
                                console.log("获取客户所在省份请求失败")
                            }
                        })
                    },
                    error: function(result) {
                        console.log('搜索请求失败');
                    }
                })
            },
            // 重置搜索框
            resettingHandle: function() {
                vm.cIndustryLineText = '';        // 行业线
                vm.cExpectSignDateRange = '';     // 预计签约时间
                vm.cProjectSuccessRateText = '';  // 成功率
                vm.cMngSalesGroupText = '';       // 事业部
                vm.cRegionText = '';              // 区域
                vm.cCustomerSourText = '';        // 客户来源
                vm.cSoSolutionText = '';          // 解决方案
                vm.cLatelyChangeText = '';        // 近期变更过
                this.tableList = {};
                this.showData();
            },
            // 新增
            addData: function() {
                vm.dialogShow = false;
                $('.selected').text('');
                $('#addTreeName').text('');
                $('.radioCheck li').removeClass('active');

                vm.handleTemplate = {}
                vm.preSaleStaffs = []
                vm.solutionSub = []

                $('.radioCheck').each(function() {
                    var li = $(this).children('li');
                    li.click(function () {
                        $(this).addClass('active');
                        $(this).siblings().removeClass("active");
                    })
                })
            },
            // 修改
            handleData: function(item){
                vm.dialogShow = false;
                $('.radioCheck li').removeClass('active');
                // 已获取销售code
                // console.log(item.soCoreCode)

                $('.radioCheck li').click(function () {
                    $(this).addClass('active');
                    $(this).siblings().removeClass("active");
                })
                $.ajax({
                    url:  PATH + '/so/queryPipelineOne',
                    type: 'get',
                    dataType: 'json',
                    data: {
                        'soCoreCode': item.soCoreCode
                    },
                    success: function(result){

                        vm.handleTemplate = result.msg
                        console.log(vm.handleTemplate);

                        if(vm.handleTemplate.preSaleStaffs) {
                            for(var i = 0;i< vm.handleTemplate.preSaleStaffs.length;i++){
                                vm.preSaleStaffs = vm.handleTemplate.preSaleStaffs[i]
                                // console.log(vm.preSaleStaffs.userCode);
                            }
                        }
                        if(vm.handleTemplate.solutionSub) {
                            for(var i = 0;i< vm.handleTemplate.solutionSub.length;i++){
                                vm.solutionSub = vm.handleTemplate.solutionSub[i]
                            }
                        }
                        // 遍历修改接口数组中的数据，并赋值给下拉框
                        var userInfo = vm.oauthLists.userInfo;
                        if(userInfo != null) {
                            //销售小组
                            if(userInfo.mngSalesGroups != null) {
                                for(var i = 0;i<userInfo.mngSalesGroups.length;i++){
                                    // console.log(userInfo.mngSalesGroups[i].code);
                                    // console.log(vm.handleTemplate.salesGroupCode);
                                    if(userInfo.mngSalesGroups[i].code == vm.handleTemplate.salesGroupCode){
                                        $("#salesGroupCode").text(userInfo.mngSalesGroups[i].text);
                                    }
                                }
                            }
                        }
                        // 行业线
                        if(vm.searchLists.industryLines != null) {
                            for(var i = 0;i<vm.searchLists.industryLines.length;i++){
                                if(vm.searchLists.industryLines[i].code == vm.handleTemplate.industryLineCode){
                                    $("#industryLineCode").text(vm.searchLists.industryLines[i].text);
                                }
                            }
                        }
                        // 成功率
                        if(vm.searchLists.projectSuccessRates != null) {
                            for(var i = 0;i<vm.searchLists.projectSuccessRates.length;i++){
                                if(vm.searchLists.projectSuccessRates[i].code == vm.handleTemplate.successRateCode){
                                    $("#successRateCode").text(vm.searchLists.projectSuccessRates[i].text);
                                }
                            }
                        }
                        // 项目阶段
                        if(vm.searchLists.progresss != null) {
                            for(var i = 0;i<vm.searchLists.progresss.length;i++){
                                if(vm.searchLists.progresss[i].code == vm.handleTemplate.progressCode){
                                    $("#progressCode").text(vm.searchLists.progresss[i].text);
                                }
                            }
                        }
                        // 客户来源
                        if(vm.searchLists.customerSours != null) {
                            for(var i = 0;i<vm.searchLists.customerSours.length;i++){
                                if(vm.searchLists.customerSours[i].code == vm.handleTemplate.customerSourceCode){
                                    $("#customerSourceCode").text(vm.searchLists.customerSours[i].text);
                                }
                            }
                        }
                        // 客户所在省份
                        // if($('#tierFirst li').hasClass('active')) {
                        //     var code = $(this).attr('value');
                        //     vm.provinceLists = [];
                        //     vm.provinceLists = eval('result.msg.' + code)
                        // }

                        // vm.handleTemplate = {}
                        // vm.preSaleStaffs = []
                        // vm.solutionSub = []
                    },
                    error: function(){
                        console.log('修改信息 请求失败');
                    }
                })
            },
            // 添加修改提交
            submitHandle: function(addObj){
                var addObj = {
                    reportDate:         vm.cReportDate
                }

                if($(this.$refs.regionCode).hasClass('active')){
                    vm.handleTemplate.regionCode = $(this.$refs.regionCode).attr('value') // 区域
                }
                if($(this.$refs.provinceCode).hasClass('active')){
                    vm.handleTemplate.provinceCode = $(this.$refs.provinceCode).attr('value') // 所在省份
                }
                if($(this.$refs.customerPropertiesCode).hasClass('active')){
                    vm.handleTemplate.customerPropertiesCode = $(this.$refs.customerPropertiesCode).attr('value') // 客户属性
                }
                if($(this.$refs.projectNatureCode).hasClass('active')){
                    vm.handleTemplate.projectNatureCode = $(this.$refs.projectNatureCode).attr('value') // 项目性质
                }

                var  preSaleStaffList = [], // 点击修改时获取表格的值
                    solutionSubList = []; // 点击修改时获取表格的值

                preSaleStaffList.push({
                    'userCode': vm.preSaleStaffs.userCode
                })

                solutionSubList.push({
                    'solutionCode': vm.solutionSub.solutionCode,
                    'expectSignSum': vm.solutionSub.expectSignSum
                })

                //TODO 数组下对象未修改完成
                vm.handleTemplate.preSaleStaffs = JSON.stringify(preSaleStaffList);
                vm.handleTemplate.solutionSub = JSON.stringify(solutionSubList);
                // console.log(vm.handleTemplate)
                var paramm = $.param(vm.handleTemplate)
                console.log(paramm)

                $.ajax({
                    url: PATH + '/so/addOrUpdatePipeline',
                    type: 'get',
                    data: paramm,
                    dataType: 'json',
                    success: function(result){
                        if (result.code === 201) {
                            toastr.error(result.msg)
                            return;
                        }

                        if(result.success){
                            vm.dialogShow = true;
                            vm.handleTemplate = {};  // 还原模板
                            vm.showData() // 再调用表格查询
                        }
                        toastr.success('添加客户成功');
                    },
                    error: function(){
                        console.log('提交 请求失败');
                    }
                })
            },
            // 查看变动历史
            showChange: function(){
                $.ajax({
                    url: PATH + '/so/queryPipelineChangeHis',
                    type: 'get',
                    dataType: 'json',
                    success: function(result){
                        // console.log(result);
                        for(var i = 0;i < result.root.length;i++){
                            var root = result.root[i];
                            vm.changeLists.push(root);
                        }
                    },
                    error: function(){
                        console.log('查看变动历史 请求失败');
                    }
                })
            },

            // 客户选择
            selectCustomer: function() {
                vm.customerDialogShow = false;
            },
            customerDialogHide: function() {
                vm.customerDialogShow = true;
            },
            // 查询
            queryBtn: function () {
                vm.getClient()
            },

            resetBtn: function () {
                vm.hClientCode = '';
                vm.hClientName = '';
                vm.hDropText = '';
                vm.hDropCode = '';
            },
            // 行业里的点击事件
            hDrop: function (code, text) {
                vm.hDropText = text;
                vm.hDropCode = code;
            },
            // 获取客户信息
            getClient: function (page, limit) {
                var params = {
                    page:         page || 1,
                    limit:        limit || this.clientPageMost,
                    customerCode: this.hClientCode,
                    customerName: this.hClientName,
                    industryLine: this.hDropCode,
                };
                //params = Object.assign(params, obj);
                axios.get(PATH +'/crm/queryCustomerList', {params: params}).then(function (datas){
                    if (datas.data.root.length === 0) {
                        toastr.warning('没有相关信息 ！');
                        return;
                    }
                    vm.client = datas.data;
                    vm.clientPageTotal = datas.data.totalProperty;
                    vm.firstClientCode = datas.data.root[0].customerCode;
                    vm.clientPageSum = Math.ceil(vm.clientPageTotal / vm.clientPageMost);
                    vm.clientPageStart = (vm.clientPageNum *10 -9);
                    if (vm.clientPageNum === vm.clientPageSum) {
                        vm.clientPageEnd = vm.clientPageTotal;
                        return;
                    }
                    vm.clientPageEnd = vm.clientPageNum * vm.clientPageMost;
                });
            },
            // 分页的判断
            calcPage: function (type, num) {
                type === 'client' ? vm.clientPage(type, num) : vm.msgPage(type, num);
            },// calcPage

            // 分页输入回车事件
            clientEnter: function () {
                vm.getClient();
            },
            // 客户分页
            clientPage: function (type, num) {
                vm.cCheckIndex = 0;
                switch(num)
                {
                    case 'first':
                        vm.getClient(1);
                        vm.clientPageNum = 1;
                        break;
                    case 'last':
                        vm.getClient(vm.clientPageSum);
                        vm.clientPageNum = vm.clientPageSum;
                        vm.clientPageEnd = vm.clientPageTotal;
                        break;
                    case 1:
                        if(vm.clientPageNum >= vm.clientPageSum)  return;
                        vm.clientPageNum++;
                        vm.getClient(vm.clientPageNum);
                        break;
                    case -1:
                        if(vm.clientPageNum <= 1)  return;
                        vm.clientPageNum--;
                        vm.getClient(vm.clientPageNum);
                        break;

                }
            },
            // 选中客户表格tr
            selectCustomerName: function(name, index) {
                vm.cCheckIndex = index;
                vm.handleTemplate.customerName = name;
            },
            // 选中事件
            selectHandle: function() {
                vm.customerDialogShow = true;
            },


            // 导入
            upload: function () {
                vm.uploadDialogShow = false;
            },
            // 确认导入
            uploadConfirm: function () {
                var file = importFile.files[0];
                vm.uploadFileName = importFile.files[0].name;
                if(importFile.files[0] == undefined) {
                    toastr.warning('请选择上传的文件 ！');
                    return
                };
                var fd = new FormData();
                fd.append('crmFile', file);
                var obj = {
                    crmFile: fd,
                };

                console.log(vm.uploadFileName);
                console.log(fd);
                console.log(obj)
                axios.post('/iboss-prism/crm/importCrm', {params: obj}).then(function (datas){
                    console.log(datas);
                    if (datas.data.code === 201) {
                        toastr.error(datas.data.msg)
                    } else{
                        toastr.success('文件上传成功 ！');
                        vm.hidePop();
                    }

                });
            },
        }
    })
</script>




